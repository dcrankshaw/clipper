# This ARG isn't used but prevents warnings in the build script
ARG CODE_VERSION
FROM r-base:3.4.4

LABEL maintainer="Dan Crankshaw <dscrankshaw@gmail.com>"

RUN apt-get update && apt-get --yes install git libzmq3-dev libtool libtool-bin libsodium-dev pkg-config build-essential autoconf automake

RUN wget http://download.zeromq.org/zeromq-4.1.4.tar.gz && tar -xvf zeromq-4.1.4.tar.gz

RUN cd zeromq-4.1.4 && ./autogen.sh && ./configure && make install

COPY containers/R/rclipper_serve rclipper_serve
COPY containers/R/deserialize_model.R deserialize_model.R
COPY containers/R/serve_model.R serve_model.R
COPY containers/R/r_container_entrypoint.sh r_container_entrypoint.sh

ENV CLIPPER_MODEL_PATH=/model
ENV CLIPPER_PORT=7000

RUN R -e "install.packages('versions', repos='http://cran.us.r-project.org')" \
    && R -e "versions::install.versions('jsonlite', version='1.5')" \
    && R -e "versions::install.versions('Rcpp', version='0.12.11')" \
    && R -e "versions::install.versions('optparse', version='1.4.4')" \
    && R -e "versions::install.versions('stringr', version='1.2.0')"

# R will return an exit code of 0 even if an install fails, so now we need to check whether the packages
# were successfully installed. The versions library has a "installed.versions()" method that checks
# the version of each listed package. It will return NA if a package has no installed version
# (and therefore is not installed). The command uses sed to find the 3rd line (https://stackoverflow.com/a/7996841/814642)
# then greps for NA in that line and checks that NA occurs 0 times.
RUN INSTALLED=$(R -q -e "versions::installed.versions(c('jsonlite', 'Rcpp', 'optparse', 'stringr'), '/usr/local/lib/R/site-library')" \
      | sed -n '3p' | grep -o NA | wc -l) && test $INSTALLED -eq "0"

RUN R CMD INSTALL rclipper_serve

ENTRYPOINT ["/r_container_entrypoint.sh"]

# vim: set filetype=dockerfile:
