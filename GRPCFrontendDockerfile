FROM frolvlad/alpine-gxx


RUN apk add --update curl git bash make boost-dev \
        cmake libev-dev hiredis-dev zeromq-dev autoconf automake libtool

RUN curl -LO https://github.com/google/protobuf/archive/v3.3.0.zip \
        && unzip v3.3.0.zip \
        && cd protobuf-3.3.0 \
        && ./autogen.sh \
        && ./configure \
        && make


RUN cd /protobuf-3.3.0 && make install

COPY ./ /clipper

RUN cd /clipper \
    && ./configure --cleanup-quiet \
    && git submodule foreach --recursive git clean -xfdf \
    && git submodule foreach --recursive git reset --hard \
    && cd /clipper/src/libs/spdlog \
    && git apply ../patches/make_spdlog_compile_linux.patch \
    && cd /clipper \
    && ./configure --release \
    && cd release \
    && make clipper_grpc_frontend

ENTRYPOINT ["/clipper/release/src/rpc_frontend/clipper_grpc_frontend"]

# vim: set filetype=dockerfile:
